<!DOCTYPE html>
<html>
  <head>
    <script src="jpg_encoder.js"></script>
    <script src="jpg_decoder.js"></script>
    <script src="seedrandom.js"></script>
    <script src="matrix.js"></script>
    <script src="solver3.js"></script>
    <script src="solver4.js"></script>
  </head>
  <body>
    <input type="file" id="image-select"></input><button id="encodeButton">Encode</button><button id="decodeButton">Decode</button>
    <br />
    Decoded: <canvas id="canvas"></canvas>
    Encoded: <img id="encoded"></img>
    <script>

    var decodedLumaArr;
    var encodedLumaArr;

    var mlbc = JSON.parse('{"k":3,"n":27,"l":11,"r":13,"G1":[[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,1],[0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,1,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,1,1,1,1,1,0,0,1]],"Ht":[[0,1,1,1,1,1,1,1,0,0,0,0,1],[1,1,0,1,1,0,0,0,1,0,0,0,0],[1,0,0,1,0,1,1,1,1,1,0,0,1],[1,0,1,0,1,1,1,0,1,0,0,0,0],[0,0,1,0,0,0,0,0,0,1,0,0,1],[1,1,0,0,1,0,1,0,1,1,1,1,1],[0,1,1,0,0,0,1,0,1,1,0,0,1],[0,1,1,0,0,0,0,0,0,1,0,0,1],[1,0,1,0,0,1,0,0,1,0,0,0,0],[0,0,1,0,0,0,1,0,1,1,0,0,0],[0,1,0,1,1,1,0,1,1,0,1,1,0],[1,1,0,1,1,0,0,0,1,0,0,1,0],[1,0,1,0,0,1,0,0,0,0,0,1,0],[1,0,0,1,0,0,1,0,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0],[0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1]],"Jt":[[1,0,0],[0,1,0],[0,0,1],[1,1,1],[1,0,0],[0,1,0],[0,0,0],[0,1,1],[1,1,0],[0,0,0],[0,1,0],[0,0,0],[1,1,0],[1,0,1],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],"G0":[[1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1,1,0,1,1,0,0,0],[1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,1,0,0,0],[0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,1,1,1,1],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,1,1,0,0,1],[0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0,0,0,0],[1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,1,1,0,0,0],[0,1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,0,1,1,0,0,0,1,0,0,1,0],[1,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,1,1,0,0,1,1],[1,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,1,0,0,0,1,0,1]]}');

      function decodeImage(canvasId, url, decodingDctFunction, callback) {
        var j = new JpegImage();
        j.onload = function(DU_DCT_ARRAY) {
          // Hack to handle the luma sometimes being 0 index and sometimes 1 indexed
          if (DU_DCT_ARRAY[0] == undefined) {
            decodingDctFunction(DU_DCT_ARRAY[1], DU_DCT_ARRAY[1].length);
          } else {
            decodingDctFunction(DU_DCT_ARRAY[0], DU_DCT_ARRAY[0].length);
          }
          var c = document.getElementById(canvasId);
          c.width = j.width;
          c.height = j.height;
          var ctx = c.getContext("2d");
          var d = ctx.getImageData(0,0,j.width,j.height);
          j.copyToImageData(d);
          ctx.putImageData(d, 0, 0);
          callback();
        };
        j.load(url, true);
      }

      function decodingDctFunction(LUMA_ARRAY, blocks) {
        decodedLumaArr = LUMA_ARRAY.slice(0);
        console.log(decodedLumaArr);

        coeffs = getValidCoeffs(LUMA_ARRAY, blocks);
        console.log("Getting valid blocks in DCT array with blocks: "+blocks+" to retreive data");

        var password = "password";
        shuffle(coeffs, password);

        stream = [];
        for (var i = 0; i<coeffs.length; i++) {
          pos = intToPair(coeffs[i]);
          stream.push(Math.abs(LUMA_ARRAY[pos.block][pos.k]%2));
        }

        decodeLongMessage(mlbc, stream);
      }

      function encodeCanvas(canvasId, qf, dctFunction){
        var cvs = document.getElementById(canvasId);
        var ctx = cvs.getContext("2d");
        var theImgData = (ctx.getImageData(0, 0, cvs.width, cvs.height));
        encodeData(canvasId, qf, dctFunction);
      }

      function encodeData(theImgData, qf, dctFunction){
        console.log(theImgData);
        var encoder = new JPEGEncoder();
        var jpegURI = encoder.encode(theImgData,qf,dctFunction);
        
        var img = document.getElementById('encoded');
        img.src = jpegURI;
      }

      function encodingDctFunction(DU_DCT_ARRAY, blocks) {
        console.log(DU_DCT_ARRAY);
        LUMA_ARRAY = DU_DCT_ARRAY[0];

        encodedLumaArr = LUMA_ARRAY.slice(0);

        coeffs = getValidCoeffs(LUMA_ARRAY, blocks);
        console.log("Getting valid coefficients in array with blocks: "+blocks+" for encoding")

        var password = "password";
        shuffle(coeffs, password);

        stream = [];
        for (var i = 0; i<coeffs.length; i++) {
          pos = intToPair(coeffs[i]);
          stream.push(LUMA_ARRAY[pos.block][pos.k]%2);
        }

        messageToHide = encodeLongMessage(mlbc, "Hello world!", stream);

        for (var i = 0; i<messageToHide.length; i++) {
          pos = intToPair(coeffs[i]);
          if (LUMA_ARRAY[pos.block][pos.k]%2 != messageToHide[i]) {
            LUMA_ARRAY[pos.block][pos.k] += 1;
          }
        }     

      }

      function getImageDataFromURL(URL, callback){
        var img = document.createElement('img');
        img.onload = function() {
          var cvs = document.createElement('canvas');
          cvs.width = img.width;
          cvs.height = img.height;
          var ctx = cvs.getContext("2d");
          ctx.drawImage(img,0,0);
          window.data = ctx.getImageData(0, 0, cvs.width, cvs.height);
          callback(ctx.getImageData(0, 0, cvs.width, cvs.height));
        };
        img.src = URL; // Set source path
      }

      function intToPair(i) {
        var block = Math.floor(i/64);
        var k = i%64;
        return {block: block, k: k};
      }

      function pairToInt(block, k) {
        return (64*block + k);
      }

      function random(from, to) {
        return (from + Math.floor(0.5 + Math.random()*(to-from)));
      }

      function shuffle(arr, password) {
        Math.seedrandom(password);
        for (var i = arr.length - 1; i > 0; i--) {
          j = random(0, i)
          swap = arr[j];
          arr[j] = arr[i];
          arr[i] = swap;
        }
        Math.seedrandom();
        return arr;
      }

      function getValidCoeffs(arr, blocks) {
        var coeffs = []
        for (var block = 0; block < blocks; block++){
          for (var k = 1; k <= 1; k++) {
            coeffs.push(pairToInt(block, k));
          }
        }
        return coeffs;
      }

      function compareArrays() {
        var blocks = decodedLumaArr.length;
        errors = [];
        totals = [];
        for (var i = 0; i < blocks; i++){
          for (var k = 0; k < 64; k++) {
            
            if (errors[k] == undefined) {
              errors[k] = 0;
              totals[k] = 0;
            }

            if (decodedLumaArr[i][k] != 0) {
              if (decodedLumaArr[i][k] != encodedLumaArr[i][k]) {
                errors[k]++;
              }
              totals[k]++;
            }

          }
        }
        for (var k = 0; k < 64; k++) {
          errorRate = errors[k]/totals[k];
          if (isNaN(errorRate)) {
            errorRate = 0;
          }
          errorRate = Math.round(errorRate*1000)/10;
          console.log(k+": "+errors[k]+" errors in "+totals[k]+" non-zeros. "+errorRate+"%");
        }
      }

      var objectURL;
      function handleFileSelect(evt) {
        files = evt.target.files;
        f = files[0];
        objectURL = window.webkitURL.createObjectURL(f);
        // setTimeout(function() { compareArrays(); }, 2000);
      }

      function decodeImageClicked () {
        decodeImage('canvas', objectURL, decodingDctFunction, function(){});
      }

      function encodeImageClicked() {
        getImageDataFromURL(objectURL, function(data) {encodeData(data, 75, encodingDctFunction)});
      }

      document.getElementById("image-select").addEventListener("change", handleFileSelect, false);
      document.getElementById("decodeButton").addEventListener("click", decodeImageClicked);
      document.getElementById("encodeButton").addEventListener("click", encodeImageClicked);

    </script>
  </body>
</html>
